# Домашнее задание к занятию "6.4. PostgreSQL"

## Задача 1

Используя docker поднимите инстанс PostgreSQL (версию 13). Данные БД сохраните в volume.

Подключитесь к БД PostgreSQL используя `psql`.

Воспользуйтесь командой `\?` для вывода подсказки по имеющимся в `psql` управляющим командам.

**Найдите и приведите** управляющие команды для:
- вывода списка БД
- подключения к БД
- вывода списка таблиц
- вывода описания содержимого таблиц
- выхода из psql

```
\l вывода списка БД

\c подключения к БД

\dt  вывода списка таблиц

\d[S+] вывода описания содержимого таблиц

quit; выхода из psql

```

## Задача 2

Используя `psql` создайте БД `test_database`.

Изучите [бэкап БД](https://github.com/netology-code/virt-homeworks/tree/master/06-db-04-postgresql/test_data).

Восстановите бэкап БД в `test_database`.

Перейдите в управляющую консоль `psql` внутри контейнера.

Подключитесь к восстановленной БД и проведите операцию ANALYZE для сбора статистики по таблице.

Используя таблицу [pg_stats](https://postgrespro.ru/docs/postgresql/12/view-pg-stats), найдите столбец таблицы `orders` 
с наибольшим средним значением размера элементов в байтах.

**Приведите в ответе** команду, которую вы использовали для вычисления и полученный результат.


![06-1](https://user-images.githubusercontent.com/106814458/197866657-6327a461-8bef-4556-9087-65d2c56b3fc1.jpg)


## Задача 3

Архитектор и администратор БД выяснили, что ваша таблица orders разрослась до невиданных размеров и
поиск по ней занимает долгое время. Вам, как успешному выпускнику курсов DevOps в нетологии предложили
провести разбиение таблицы на 2 (шардировать на orders_1 - price>499 и orders_2 - price<=499).

Предложите SQL-транзакцию для проведения данной операции.

![06-2](https://user-images.githubusercontent.com/106814458/197870889-bcba44bd-fc7e-4069-937f-71937adc6162.jpg)

Далее занес из "старой" таблицы данные в "новую" уже имеющую партции данные с помощью инсёрта :

```
test_database=# insert into orders (id, title, price) select * from orders_old;
INSERT 0 8
test_database=#
```

Можно ли было изначально исключить "ручное" разбиение при проектировании таблицы orders?

```
Конечно , перед наполнением данных таблицу изначально можно было бы создать с партициями и тогда бы не пришлось этого делать в ручную позже.
```



## Задача 4

Используя утилиту `pg_dump` создайте бекап БД `test_database`.

![06-3](https://user-images.githubusercontent.com/106814458/197871676-516d1b77-47f6-4e19-ade5-a99c61e9cb12.jpg)


Как бы вы доработали бэкап-файл, чтобы добавить уникальность значения столбца `title` для таблиц `test_database`?

Можно было бы добавить индекс :

```
CREATE INDEX ON orders ((lower(title)));
```
Если я правильно понял доку по postgre то можно поступить следующим образом:

```
ALTER TABLE ONLY orders ADD UNIQUE (title);

ALTER TABLE orders_less499 ADD UNIQUE (title);
ALTER TABLE orders_more499 ADD UNIQUE (title);
ALTER INDEX orders_title
    ATTACH PARTITION orders_less499_title
    ATTACH PARTITION orders_more499_title
```


---

